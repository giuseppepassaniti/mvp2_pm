<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Imprevisti - MVP2 Completo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden-on-start { display: none; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
        .timeline-item::before { content: ''; position: absolute; left: 19px; top: 24px; bottom: 0; width: 2px; background-color: #e2e8f0; }
        .timeline-item:last-child::before { display: none; }
        .sortable:hover { background-color: #f8fafc; cursor: pointer; }
        .sort-asc::after { content: ' ▲'; font-size: 0.7em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.7em; }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Dashboard Imprevisti di Progetto</h1>
            <p class="text-slate-600 mt-1">Monitoraggio degli imprevisti (Dati da JSON).</p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="filters-panel" class="hidden-on-start grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div class="lg:col-span-1"><label for="project-filter" class="block text-sm font-medium text-slate-700 mb-1">Progetto</label><select id="project-filter" class="p-2 border rounded-md bg-white shadow-sm w-full"></select></div>
                <div class="lg:col-span-2 grid grid-cols-2 gap-2">
                    <div><label for="date-start-filter" class="block text-sm font-medium text-slate-700 mb-1">Da Data</label><input type="date" id="date-start-filter" class="p-2 border rounded-md bg-white shadow-sm w-full text-sm"></div>
                    <div><label for="date-end-filter" class="block text-sm font-medium text-slate-700 mb-1">A Data</label><input type="date" id="date-end-filter" class="p-2 border rounded-md bg-white shadow-sm w-full text-sm"></div>
                </div>
                <div class="lg:col-span-1"><label class="block text-sm font-medium text-slate-700 mb-1">Stato</label><div id="status-filter-container" class="flex flex-wrap items-center gap-x-4 gap-y-2 pt-2"></div></div>
                <div class="lg:col-span-1"><label class="block text-sm font-medium text-slate-700 mb-1">Criticità</label><div id="criticality-filter-container" class="flex flex-wrap items-center gap-x-4 gap-y-2 pt-2"></div></div>
            </div>
        </div>

        <div id="initial-message" class="text-center py-12 bg-white rounded-lg shadow-md">
             <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-slate-400 animate-spin"></i>
            <h3 class="mt-2 text-sm font-medium text-slate-900">Caricamento dati...</h3>
        </div>

        <div id="dashboard-container" class="hidden-on-start">
            <section id="kpi-section" class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4"></section>
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                <div class="flex items-center bg-slate-200 rounded-lg p-1">
                    <button id="view-cards-btn" class="px-4 py-1 text-sm font-semibold rounded-md bg-white shadow text-blue-600">Card</button>
                    <button id="view-table-btn" class="px-4 py-1 text-sm font-semibold rounded-md text-slate-600">Tabella</button>
                    <button id="view-timeline-btn" class="px-4 py-1 text-sm font-semibold rounded-md text-slate-600">Timeline</button>
                </div>
                <div class="relative w-full md:w-1/3">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400"></i>
                    <input type="text" id="search-input" placeholder="Cerca per titolo, tipo, rischio..." class="w-full pl-10 p-2 border rounded-md bg-white shadow-sm">
                </div>
            </div>
            <div id="preview-section" class="mb-2 text-sm text-slate-500"></div>
            <main id="main-content"></main>
        </div>
    </div>

    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"><div id="modal-overlay" class="absolute inset-0 bg-black/60 modal-overlay opacity-0"></div><div id="modal-container" class="bg-white rounded-lg shadow-xl w-full max-w-2xl z-10 transform scale-95 modal-container"><div class="p-6"><div class="flex justify-between items-start"><div id="modal-header"></div><button id="modal-close-btn" class="p-1 rounded-full hover:bg-slate-200"><i data-lucide="x" class="h-6 w-6 text-slate-600"></i></button></div><div class="mt-4 border-t pt-4"><p id="modal-description" class="text-slate-700 whitespace-pre-wrap"></p></div></div></div></div>

    <script type="module">
        import { getDataManager } from './utils/datamanager.js';
        let allIncidents = [], filteredIncidents = [], currentView = 'cards', sortConfig = { key: 'date', direction: 'desc' }, typeChart = null;
        const dom = { initialMessage: document.getElementById('initial-message'), dashboardContainer: document.getElementById('dashboard-container'), filtersPanel: document.getElementById('filters-panel'), projectFilter: document.getElementById('project-filter'), dateStartFilter: document.getElementById('date-start-filter'), dateEndFilter: document.getElementById('date-end-filter'), statusFilterContainer: document.getElementById('status-filter-container'), criticalityFilterContainer: document.getElementById('criticality-filter-container'), searchInput: document.getElementById('search-input'), kpiSection: document.getElementById('kpi-section'), mainContent: document.getElementById('main-content'), previewSection: document.getElementById('preview-section'), viewButtons: { cards: document.getElementById('view-cards-btn'), table: document.getElementById('view-table-btn'), timeline: document.getElementById('view-timeline-btn') }, modal: { element: document.getElementById('details-modal'), overlay: document.getElementById('modal-overlay'), container: document.getElementById('modal-container'), closeBtn: document.getElementById('modal-close-btn'), header: document.getElementById('modal-header'), description: document.getElementById('modal-description') } };
        const criticalityInfo = { 'Alta':{icon:'alert-octagon',badge:'border-red-500 text-red-600 bg-red-100'}, 'Media':{icon:'alert-triangle',badge:'border-orange-500 text-orange-600 bg-orange-100'}, 'Bassa':{icon:'shield-check',badge:'border-green-500 text-green-600 bg-green-100'} };
        const statusInfo = { 'Aperto':{badge:'bg-red-100 text-red-800'}, 'Risolto':{badge:'bg-green-100 text-green-800'} };

        async function initializeDashboard() {
            try {
                const dm = await getDataManager();
                allIncidents = dm.imprevisti.map((inc, index) => {
                    if (!inc['Titolo Imprevisto'] || !inc.Progetto?.[0] || !inc['Data Imprevisti']) return null;
                    const project = dm.progettiMap.get(inc.Progetto[0]);
                    return { id: index, title: inc['Titolo Imprevisto'], description: inc['Descrizione Problema'] || 'N/D', projectName: project ? project['Id Progetto'] : 'N/D', type: inc.Tipo || 'N/D', criticality: inc.Criticità || 'Bassa', date: new Date(inc['Data Imprevisti']), status: inc.Stato || 'Aperto', risk: inc['Rischio Previsionale'] || 'N/D' };
                }).filter(Boolean);
                
                dom.initialMessage.style.display = 'none';
                dom.dashboardContainer.classList.remove('hidden-on-start');
                dom.filtersPanel.classList.remove('hidden-on-start');
                populateFilters();
                handleUrlParams(dm);
                renderDashboard();
            } catch (error) { console.error("Errore:", error); dom.initialMessage.innerHTML = `<h3>Errore nel caricamento dati.</h3>`; }
        }

        function handleUrlParams(dm) {
            const pId = new URLSearchParams(window.location.search).get('id');
            if (!pId) return;
            const project = dm.progettiMap.get(pId);
            if (project) {
                const pReadableId = project['Id Progetto'];
                if ([...dom.projectFilter.options].some(o => o.value === pReadableId)) {
                    dom.projectFilter.value = pReadableId;
                    dom.projectFilter.disabled = true;
                }
            }
        }

        function populateFilters() {
            const createCheckboxes = (container, items) => { container.innerHTML = items.map(item => `<div class="flex items-center"><input type="checkbox" id="${item}" value="${item}" class="h-4 w-4 rounded filter-checkbox"><label for="${item}" class="ml-2 text-sm">${item}</label></div>`).join(''); };
            const projects = ['all', ...new Set(allIncidents.map(i => i.projectName).sort())];
            dom.projectFilter.innerHTML = projects.map(p => `<option value="${p}">${p === 'all' ? 'Tutti i Progetti' : p}</option>`).join('');
            createCheckboxes(dom.statusFilterContainer, [...new Set(allIncidents.map(i => i.status))]);
            createCheckboxes(dom.criticalityFilterContainer, ['Alta', 'Media', 'Bassa']);
        }

        function renderDashboard() { applyFiltersAndSort(); renderKPIs(); renderCurrentView(); lucide.createIcons(); }
        function applyFiltersAndSort() {
            const startDate = dom.dateStartFilter.value ? new Date(dom.dateStartFilter.value) : null; if(startDate) startDate.setHours(0,0,0,0);
            const endDate = dom.dateEndFilter.value ? new Date(dom.dateEndFilter.value) : null; if(endDate) endDate.setHours(23,59,59,999);
            const selectedStatuses = Array.from(dom.statusFilterContainer.querySelectorAll('input:checked')).map(el => el.value);
            const selectedCriticalities = Array.from(dom.criticalityFilterContainer.querySelectorAll('input:checked')).map(el => el.value);
            const searchTerm = dom.searchInput.value.toLowerCase();
            filteredIncidents = allIncidents.filter(inc => (dom.projectFilter.value==='all'||inc.projectName===dom.projectFilter.value) && (!startDate||inc.date>=startDate) && (!endDate||inc.date<=endDate) && (selectedStatuses.length===0||selectedStatuses.includes(inc.status)) && (selectedCriticalities.length===0||selectedCriticalities.includes(inc.criticality)) && (!searchTerm||inc.title.toLowerCase().includes(searchTerm)||inc.type.toLowerCase().includes(searchTerm)||inc.risk.toLowerCase().includes(searchTerm)));
            filteredIncidents.sort((a,b)=>{let vA=a[sortConfig.key],vB=b[sortConfig.key]; if(sortConfig.key==='criticality'){const o={'Alta':0,'Media':1,'Bassa':2};vA=o[vA]??99;vB=o[vB]??99;} if(vA<vB)return sortConfig.direction==='asc'?-1:1; if(vA>vB)return sortConfig.direction==='asc'?1:-1; return 0;});
        }
        function renderCurrentView() { Object.values(dom.viewButtons).forEach(b=>b.classList.remove('bg-white','shadow','text-blue-600')); dom.viewButtons[currentView].classList.add('bg-white','shadow','text-blue-600'); dom.previewSection.innerHTML=`Mostrando ${filteredIncidents.length} su ${allIncidents.length} imprevisti.`; if(currentView==='cards')renderCardView(); else if(currentView==='table')renderTableView(); else if(currentView==='timeline')renderTimelineView();}
        function renderKPIs(){ const total=filteredIncidents.length; const open=filteredIncidents.filter(i=>i.status==='Aperto').length; const highCritOpen=filteredIncidents.filter(i=>i.criticality==='Alta'&&i.status==='Aperto').length; const byType=filteredIncidents.reduce((acc,{type})=>{acc[type]=(acc[type]||0)+1;return acc;},{}); const byProject=filteredIncidents.reduce((acc,{projectName,criticality,status})=>{if(!acc[projectName])acc[projectName]={total:0,high_criticality_open:0};acc[projectName].total++;if(criticality==='Alta'&&status!=='Risolto')acc[projectName].high_criticality_open++;return acc;},{}); let projectRiskHTML=Object.entries(byProject).map(([proj,data])=>{let color=data.high_criticality_open>2?'text-red-500':(data.high_criticality_open>0?'text-orange-500':'text-green-500'); return `<div class="flex items-center justify-between text-sm"><span class="font-medium">${proj}</span><i data-lucide="circle" class="h-4 w-4 ${color} fill-current"></i></div>`;}).join(''); dom.kpiSection.innerHTML=`<div class="bg-white p-4 rounded-lg shadow-md flex items-center col-span-1"><i data-lucide="list-todo" class="h-10 w-10 text-blue-500"></i><div class="ml-4"><p class="text-slate-500 text-sm">Totale</p><p class="text-2xl font-bold">${total}</p></div></div><div class="bg-white p-4 rounded-lg shadow-md flex items-center col-span-1"><i data-lucide="folder-open" class="h-10 w-10 text-orange-500"></i><div class="ml-4"><p class="text-slate-500 text-sm">Aperti</p><p class="text-2xl font-bold">${open}</p></div></div><div class="bg-white p-4 rounded-lg shadow-md flex items-center col-span-1"><i data-lucide="alert-triangle" class="h-10 w-10 text-red-500"></i><div class="ml-4"><p class="text-slate-500 text-sm">Aperti Critici</p><p class="text-2xl font-bold">${highCritOpen}</p></div></div><div class="bg-white p-4 rounded-lg shadow-md col-span-2 lg:col-span-1"><p class="font-bold mb-2">Semaforo Progetti</p><div class="space-y-2">${projectRiskHTML||'<p class="text-sm text-slate-400">Nessun progetto.</p>'}</div></div><div class="bg-white p-4 rounded-lg shadow-md col-span-full md:col-span-1"><canvas id="type-chart"></canvas></div>`; if(typeChart)typeChart.destroy(); typeChart=new Chart(document.getElementById('type-chart').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(byType),datasets:[{data:Object.values(byType),backgroundColor:['#3b82f6','#f59e0b','#10b981','#ef4444','#8b5cf6']}]},options:{responsive:true,plugins:{legend:{position:'right',labels:{boxWidth:12,font:{size:10}}},title:{display:true,text:'Imprevisti per Tipo'}}}});}
        function renderCardView(){if(filteredIncidents.length===0){mainContent.innerHTML=`<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessun imprevisto.</p></div>`;return;} mainContent.innerHTML=`<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">${filteredIncidents.map(inc=>{const crit=criticalityInfo[inc.criticality]||{};const stat=statusInfo[inc.status]||{};return `<div class="bg-white rounded-lg shadow p-4 border-l-4 ${crit.badge?.split(' ')[0]}" data-id="${inc.id}" style="cursor: pointer;"><div class="flex justify-between items-start"><h4 class="font-bold text-slate-800">${inc.title}</h4><span class="px-2 py-1 text-xs font-semibold rounded-full ${stat.badge}">${inc.status}</span></div><p class="text-sm text-slate-500 mt-1">${inc.projectName} &bull; ${inc.type}</p><div class="mt-3 pt-3 border-t flex justify-between items-center text-sm"><span class="flex items-center gap-2 text-slate-600"><i data-lucide="calendar" class="h-4 w-4"></i>${dayjs(inc.date).format('DD MMM YYYY')}</span><span class="font-semibold px-2 py-1 rounded ${crit.badge}">${inc.criticality}</span></div></div>`;}).join('')}</div>`; mainContent.querySelectorAll('[data-id]').forEach(card=>card.addEventListener('click',()=>showModal(card.dataset.id)));}
        function renderTableView(){if(filteredIncidents.length===0){mainContent.innerHTML=`<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessun imprevisto.</p></div>`;return;} const headers=['Titolo','Progetto','Tipo','Criticità','Stato','Data','Rischio','']; mainContent.innerHTML=`<div class="overflow-x-auto bg-white rounded-lg shadow"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>${headers.map(h=>`<th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort-key="${h.toLowerCase()}">${h}</th>`).join('')}</tr></thead><tbody class="divide-y divide-slate-200">${filteredIncidents.map(inc=>{const crit=criticalityInfo[inc.criticality]||{};const stat=statusInfo[inc.status]||{};return `<tr class="hover:bg-slate-50"><td class="px-4 py-3 text-sm font-medium">${inc.title}</td><td class="px-4 py-3 text-sm">${inc.projectName}</td><td class="px-4 py-3 text-sm">${inc.type}</td><td class="px-4 py-3 text-sm"><span class="font-semibold ${crit.badge} px-2 py-1 rounded">${inc.criticality}</span></td><td class="px-4 py-3 text-sm"><span class="font-semibold ${stat.badge} px-2 py-1 rounded">${inc.status}</span></td><td class="px-4 py-3 text-sm">${dayjs(inc.date).format('DD/MM/YYYY')}</td><td class="px-4 py-3 text-sm">${inc.risk}</td><td class="px-4 py-3 text-sm"><button class="text-blue-600 hover:underline" data-id="${inc.id}">Dettagli</button></td></tr>`;}).join('')}</tbody></table></div>`; mainContent.querySelectorAll('[data-id]').forEach(btn=>btn.addEventListener('click',()=>showModal(btn.dataset.id))); document.querySelectorAll('.sortable').forEach(h=>h.addEventListener('click',()=>{const key=h.dataset.sortKey;sortConfig.direction=sortConfig.key===key&&sortConfig.direction==='asc'?'desc':'asc';sortConfig.key=key;renderTableView();}));}
        function renderTimelineView(){if(filteredIncidents.length===0){mainContent.innerHTML=`<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessun imprevisto.</p></div>`;return;} const sorted=filteredIncidents.sort((a,b)=>b.date-a.date); mainContent.innerHTML=`<div class="space-y-8 relative p-4">${sorted.map(inc=>{const crit=criticalityInfo[inc.criticality]||{};return `<div class="relative flex items-start timeline-item"><div class="flex-shrink-0 w-10 h-10 rounded-full bg-white border-2 ${crit.badge?.split(' ')[0]} flex items-center justify-center z-10"><i data-lucide="${crit.icon}" class="h-5 w-5 ${crit.badge?.split(' ')[1]}"></i></div><div class="ml-4 bg-white p-4 rounded-lg shadow-md flex-grow"><div class="flex justify-between items-center"><p class="font-bold">${inc.title}</p><span class="text-sm font-medium text-slate-500">${dayjs(inc.date).format('DD MMMM YYYY')}</span></div><p class="text-sm text-slate-600">${inc.projectName} &bull; ${inc.type}</p><button class="text-sm text-blue-600 hover:underline mt-2" data-id="${inc.id}">Leggi descrizione</button></div></div>`;}).join('')}</div>`; mainContent.querySelectorAll('[data-id]').forEach(btn=>btn.addEventListener('click',()=>showModal(btn.dataset.id)));}
        function showModal(id){const inc=allIncidents.find(i=>i.id==id);if(!inc)return; dom.modal.header.innerHTML=`<h3 class="text-2xl font-bold text-slate-900">${inc.title}</h3><p class="text-sm text-slate-500">${inc.projectName}</p>`; dom.modal.description.textContent=inc.description; dom.modal.element.classList.remove('hidden'); setTimeout(()=>{dom.modal.overlay.classList.remove('opacity-0');dom.modal.container.classList.remove('scale-95');},10);}
        function hideModal(){dom.modal.overlay.classList.add('opacity-0'); dom.modal.container.classList.add('scale-95'); setTimeout(()=>dom.modal.element.classList.add('hidden'),300);}
        
        document.querySelectorAll('#filters-panel input, #filters-panel select, .filter-checkbox').forEach(el => el.addEventListener('change', renderDashboard));
        dom.searchInput.addEventListener('input', renderDashboard);
        Object.keys(dom.viewButtons).forEach(key => dom.viewButtons[key].addEventListener('click', () => { currentView = key; renderCurrentView(); }));
        dom.modal.closeBtn.addEventListener('click', hideModal); dom.modal.overlay.addEventListener('click', hideModal);

        initializeDashboard();
    </script>
</body>
</html>
