<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Varianti - MVP2</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden-on-start { display: none; }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Dashboard Varianti Progettuali</h1>
            <p class="text-slate-600 mt-1">Analisi impatto varianti (Dati da JSON).</p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="filters-panel" class="hidden-on-start grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="project-filter" class="p-2 border rounded-md bg-white shadow-sm w-full"></select>
                <select id="status-filter" class="p-2 border rounded-md bg-white shadow-sm w-full">
                    <option value="all">Tutti gli Stati</option>
                    <option value="Approvata">Approvata</option>
                    <option value="In valutazione">In valutazione</option>
                    <option value="Rifiutata">Rifiutata</option>
                </select>
                <input type="text" id="search-input" placeholder="Cerca per tipo di variante..." class="p-2 border rounded-md bg-white shadow-sm w-full md:col-span-2">
            </div>
        </div>

        <div id="initial-message" class="text-center py-12 bg-white rounded-lg shadow-md">
             <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-slate-400 animate-spin"></i>
            <h3 class="mt-2 text-sm font-medium text-slate-900">Caricamento dati centralizzato...</h3>
        </div>

        <div id="dashboard-container" class="hidden-on-start">
            <section id="kpi-section" class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></section>
            <div id="preview-section" class="mb-2 text-sm text-slate-500"></div>
            <main id="main-content"></main>
        </div>
    </div>

    <script type="module">
        import { getDataManager } from './utils/datamanager.js';

        let allProcessedVariants = [];
        let filteredVariants = [];
        let impactChart = null;

        const dom = {
            initialMessage: document.getElementById('initial-message'),
            dashboardContainer: document.getElementById('dashboard-container'),
            filtersPanel: document.getElementById('filters-panel'),
            projectFilter: document.getElementById('project-filter'),
            statusFilter: document.getElementById('status-filter'),
            searchInput: document.getElementById('search-input'),
            kpiSection: document.getElementById('kpi-section'),
            previewSection: document.getElementById('preview-section'),
            mainContent: document.getElementById('main-content'),
        };

        const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value || 0);
        const formatDays = (value) => `${(value || 0) > 0 ? '+' : ''}${value || 0} giorni`;

        async function initializeDashboard() {
            try {
                const dm = await getDataManager();

                allProcessedVariants = dm.varianti.map((v, index) => {
                    if (!v.Variante || !v.Progetto?.[0] || !v['Data Variante']) return null;

                    const project = dm.progettiMap.get(v.Progetto[0]);
                    const projectName = project ? project['Id Progetto'] : 'N/D';

                    return {
                        id: index,
                        type: v.Variante,
                        description: v['Descrizione Variante'] || 'Nessuna descrizione.',
                        projectName: projectName,
                        date: new Date(v['Data Variante']),
                        timeImpact: v['Impatto Tempi (in giorni)'] || 0,
                        costImpact: v['Impatto Costi'] || 0,
                        status: v.Stato || 'In valutazione',
                    };
                }).filter(Boolean);
                
                dom.initialMessage.style.display = 'none';
                dom.dashboardContainer.classList.remove('hidden-on-start');
                dom.filtersPanel.classList.remove('hidden-on-start');

                populateFilters();
                renderDashboard();

            } catch (error) {
                console.error("Errore inizializzazione dashboard Varianti:", error);
                dom.initialMessage.innerHTML = `<h3>Errore nel caricamento dei dati.</h3>`;
            }
        }

        function populateFilters() {
            const projects = ['all', ...new Set(allProcessedVariants.map(v => v.projectName).sort())];
            dom.projectFilter.innerHTML = projects.map(p => `<option value="${p}">${p === 'all' ? 'Tutti i Progetti' : p}</option>`).join('');
        }
        
        function renderDashboard() {
            applyFilters();
            renderKPIs();
            renderTableView();
        }

        function applyFilters() {
            const searchTerm = dom.searchInput.value.toLowerCase();
            filteredVariants = allProcessedVariants.filter(v => {
                const projectMatch = dom.projectFilter.value === 'all' || v.projectName === dom.projectFilter.value;
                const statusMatch = dom.statusFilter.value === 'all' || v.status === dom.statusFilter.value;
                const searchMatch = !searchTerm || v.type.toLowerCase().includes(searchTerm);
                return projectMatch && statusMatch && searchMatch;
            });
        }

        function renderKPIs() {
            const total = filteredVariants.length;
            const totalTimeImpact = filteredVariants.reduce((sum, v) => sum + v.timeImpact, 0);
            const totalCostImpact = filteredVariants.reduce((sum, v) => sum + v.costImpact, 0);
            const byStatus = filteredVariants.reduce((acc, { status }) => { acc[status] = (acc[status] || 0) + 1; return acc; }, {});

            dom.kpiSection.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-md flex items-center"><i data-lucide="git-pull-request-draft" class="h-10 w-10 text-blue-500"></i><div class="ml-4"><p class="text-slate-500 text-sm">Totale</p><p class="text-2xl font-bold">${total}</p></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md flex items-center"><i data-lucide="calendar-days" class="h-10 w-10 ${totalTimeImpact > 0 ? 'text-red-500' : 'text-green-500'}"></i><div class="ml-4"><p class="text-slate-500 text-sm">Impatto Tempi</p><p class="text-2xl font-bold">${formatDays(totalTimeImpact)}</p></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md flex items-center"><i data-lucide="coins" class="h-10 w-10 ${totalCostImpact > 0 ? 'text-red-500' : 'text-green-500'}"></i><div class="ml-4"><p class="text-slate-500 text-sm">Impatto Costi</p><p class="text-2xl font-bold">${formatCurrency(totalCostImpact)}</p></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md"><canvas id="impact-chart"></canvas></div>`;

            if(impactChart) impactChart.destroy();
            impactChart = new Chart(document.getElementById('impact-chart').getContext('2d'), {
                type: 'bar',
                data: { labels: ['Approvate', 'Rifiutate', 'In Valutazione'], datasets: [{ data: [byStatus['Approvata'] || 0, byStatus['Rifiutata'] || 0, byStatus['In valutazione'] || 0], backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'] }] },
                options: { responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Varianti per Stato' } } }
            });
            lucide.createIcons();
        }

        function renderTableView() {
            dom.previewSection.innerHTML = `Mostrando ${filteredVariants.length} su ${allProcessedVariants.length} varianti totali.`;
            if (filteredVariants.length === 0) {
                dom.mainContent.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessuna variante corrisponde ai filtri.</p></div>`;
                return;
            }
            
            const headers = ['Progetto', 'Variante', 'Data', 'Impatto Tempi', 'Impatto Costi', 'Stato'];
            dom.mainContent.innerHTML = `
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead>
                    <tbody class="divide-y divide-slate-200">${filteredVariants.map(createVariantRow).join('')}</tbody></table>
                </div>`;
        }

        function createVariantRow(v) {
            const statusInfo = { 'Approvata': 'bg-green-100 text-green-800', 'In valutazione': 'bg-yellow-100 text-yellow-800', 'Rifiutata': 'bg-red-100 text-red-800'}[v.status] || 'bg-slate-100';
            const timeColor = v.timeImpact > 0 ? 'text-red-600' : (v.timeImpact < 0 ? 'text-green-600' : '');
            const costColor = v.costImpact > 0 ? 'text-red-600' : (v.costImpact < 0 ? 'text-green-600' : '');
            
            return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 text-sm font-medium">${v.projectName}</td>
                    <td class="px-4 py-3 text-sm">${v.type}</td>
                    <td class="px-4 py-3 text-sm">${dayjs(v.date).format('DD/MM/YYYY')}</td>
                    <td class="px-4 py-3 text-sm font-bold ${timeColor}">${formatDays(v.timeImpact)}</td>
                    <td class="px-4 py-3 text-sm font-bold ${costColor}">${formatCurrency(v.costImpact)}</td>
                    <td class="px-4 py-3 text-sm"><span class="font-semibold ${statusInfo} px-2 py-1 rounded-full text-xs">${v.status}</span></td>
                </tr>`;
        }

        [dom.projectFilter, dom.statusFilter, dom.searchInput].forEach(el => el.addEventListener('input', renderDashboard));

        initializeDashboard();
    </script>
</body>
</html>
