<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Milestone - MVP2 Finale</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-on-start { display: none; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; width: 220px; background-color: #1f2937; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; pointer-events: none; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .gantt .grid-header { background-color: #1e3a8a; color: white; }
        .gantt .bar-label { fill: white; font-weight: 600; }
        .gantt .bar-completata .bar-progress { fill: #10b981; } .gantt .bar-completata .bar { fill: #a7f3d0; }
        .gantt .bar-in-corso .bar-progress { fill: #f59e0b; } .gantt .bar-in-corso .bar { fill: #fde68a; }
        .gantt .bar-pianificata .bar-progress { fill: #3b82f6; } .gantt .bar-pianificata .bar { fill: #bfdbfe; }
        .gantt .bar-in-ritardo .bar-progress { fill: #ef4444; } .gantt .bar-in-ritardo .bar { fill: #fecaca; }
        .gantt .bar-wrapper.dummy-task { display: none; }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Dashboard Milestone Progetti</h1>
            <p class="text-gray-600 mt-1">Visualizzazione delle milestone (Dati da JSON).</p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="controls-panel" class="hidden-on-start flex flex-col md:flex-row md:items-center gap-4 w-full justify-end">
                <div class="flex items-center bg-gray-200 rounded-lg p-1">
                    <button id="view-cards-btn" class="px-4 py-1 text-sm font-semibold rounded-md bg-white shadow text-blue-600">Card</button>
                    <button id="view-gantt-btn" class="px-4 py-1 text-sm font-semibold rounded-md text-gray-600">Gantt</button>
                </div>
                <select id="project-filter" class="p-2 border rounded-md bg-white shadow-sm"></select>
            </div>
        </div>

        <div id="initial-message" class="text-center py-12 bg-white rounded-lg shadow-md">
            <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-slate-400 animate-spin"></i>
            <h3 class="mt-2 text-sm font-medium text-slate-900">Caricamento dati...</h3>
        </div>
        
        <main id="dashboard-content" class="transition-opacity duration-500"></main>
    </div>

    <script type="module">
        import { getDataManager } from './utils/datamanager.js';

        let allProcessedMilestones = [], projectsWithMilestones = {}, currentView = 'cards';
        const dom = {
            initialMessage: document.getElementById('initial-message'),
            controlsPanel: document.getElementById('controls-panel'),
            dashboardContent: document.getElementById('dashboard-content'),
            viewCardsBtn: document.getElementById('view-cards-btn'),
            viewGanttBtn: document.getElementById('view-gantt-btn'),
            projectFilter: document.getElementById('project-filter'),
        };

        async function initializeDashboard() {
            try {
                const dm = await getDataManager();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                allProcessedMilestones = dm.milestone.map(m => {
                    const projectId = m.Progetto?.[0];
                    if (!m.Milestone || !projectId || !m['Start Date'] || !m.Deadline) return null;
                    
                    const project = dm.progettiMap.get(projectId);
                    const projectIdReadable = project ? project['Id Progetto'] : 'Sconosciuto';

                    const startDate = new Date(m['Start Date']);
                    const deadline = new Date(m.Deadline);
                    if (isNaN(startDate) || isNaN(deadline)) return null;

                    let calculatedStatus = m.Stato;
                    if (m.Stato !== 'Completata' && deadline < today) calculatedStatus = 'In ritardo';

                    return { name: m.Milestone, projectId: projectIdReadable, startDate, deadline, status: m.Stato, calculatedStatus };
                }).filter(Boolean);

                projectsWithMilestones = allProcessedMilestones.reduce((acc, m) => {
                    if (!acc[m.projectId]) acc[m.projectId] = [];
                    acc[m.projectId].push(m);
                    return acc;
                }, {});

                if (allProcessedMilestones.length > 0) {
                    dom.initialMessage.style.display = 'none';
                    dom.controlsPanel.style.display = 'flex';
                    populateProjectFilter();
                    handleUrlParams(dm);
                    renderCurrentView();
                } else {
                    dom.initialMessage.innerHTML = `<h3>Nessun dato valido trovato.</h3>`;
                }
            } catch (error) {
                console.error("Errore:", error);
                dom.initialMessage.innerHTML = `<h3>Errore nel caricamento dei dati.</h3>`;
            }
        }

        function handleUrlParams(dm) {
            const projectRecordId = new URLSearchParams(window.location.search).get('id');
            if (!projectRecordId) return;
            const project = dm.progettiMap.get(projectRecordId);
            if (project) {
                const projectIdReadable = project['Id Progetto'];
                if (projectsWithMilestones[projectIdReadable]) {
                     dom.projectFilter.value = projectIdReadable;
                     dom.projectFilter.disabled = true;
                }
            }
        }

        function renderCurrentView() {
            dom.dashboardContent.style.opacity = 0;
            setTimeout(() => {
                currentView === 'cards' ? renderCardView() : renderGanttView();
                dom.dashboardContent.style.opacity = 1;
                lucide.createIcons();
            }, 200);
        }

        function populateProjectFilter() {
            const projectIds = Object.keys(projectsWithMilestones).sort();
            dom.projectFilter.innerHTML = `<option value="all">Tutti i Progetti</option>` + projectIds.map(id => `<option value="${id}">${id}</option>`).join('');
        }
        
        function renderCardView() {
            const selectedProject = dom.projectFilter.value;
            const projectsToRender = (selectedProject === 'all') ? Object.keys(projectsWithMilestones) : [selectedProject];
            if (projectsToRender.length === 0 || !projectsWithMilestones[projectsToRender[0]]) {
                dom.dashboardContent.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessun dato per il progetto selezionato.</p></div>`; return;
            }
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6';
            projectsToRender.forEach(projectId => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-5 flex flex-col';
                const milestones = projectsWithMilestones[projectId];
                if (!milestones) return;
                const completedCount = milestones.filter(m => m.status === 'Completata').length;
                const progress = milestones.length > 0 ? (completedCount / milestones.length) * 100 : 0;
                card.innerHTML = `<h3 class="text-xl font-bold text-gray-800">${projectId}</h3><div class="mt-2 mb-3"><div class="flex justify-between mb-1"><span class="text-sm font-medium text-gray-700">Avanzamento</span><span class="text-sm font-medium text-gray-700">${Math.round(progress)}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div></div><div class="flex-grow"><div class="flex flex-wrap gap-2 py-2">${milestones.map(m => `<div class="tooltip"><span class="inline-block px-3 py-1 text-sm font-medium rounded-full border ${getStatusClasses(m.calculatedStatus)}">${m.name}</span><div class="tooltip-text">${createTooltipText(m)}</div></div>`).join('')}</div></div>`;
                grid.appendChild(card);
            });
            dom.dashboardContent.innerHTML = '';
            dom.dashboardContent.appendChild(grid);
        }

        function renderGanttView() {
            dom.dashboardContent.innerHTML = '<div id="gantt-container" class="bg-white rounded-lg shadow-md"><svg id="gantt"></svg></div>';
            const selectedProject = dom.projectFilter.value;
            let filteredMilestones = (selectedProject === 'all') ? [...allProcessedMilestones] : allProcessedMilestones.filter(m => m.projectId === selectedProject);
            if (filteredMilestones.length === 0) {
                document.getElementById('gantt-container').innerHTML = `<div class="text-center py-10"><p>Nessuna milestone da visualizzare.</p></div>`; return;
            }
            filteredMilestones.sort((a, b) => a.startDate - b.startDate);
            let tasks = filteredMilestones.map((m, i) => ({ id: `m_${i}`, name: m.name, start: m.startDate.toISOString().split('T')[0], end: m.deadline.toISOString().split('T')[0], progress: m.status === 'Completata' ? 100 : (m.status === 'In corso' ? 50 : 0), custom_class: `bar-${m.calculatedStatus.toLowerCase().replace(/\s+/g, '-')}` }));
            
            // Logica per il padding del Gantt (da MVP1)
            const firstDate = new Date(filteredMilestones[0].startDate);
            const lastDate = filteredMilestones.reduce((max, m) => m.deadline > max ? m.deadline : max, new Date(filteredMilestones[0].deadline));
            const timelineStart = new Date(firstDate); timelineStart.setMonth(timelineStart.getMonth() - 1);
            const timelineEnd = new Date(lastDate); timelineEnd.setMonth(timelineEnd.getMonth() + 1);
            tasks.unshift({id:'dummy_start',name:'',start:timelineStart.toISOString().split('T')[0],end:timelineStart.toISOString().split('T')[0],progress:0,custom_class:'dummy-task'});
            tasks.push({id:'dummy_end',name:'',start:timelineEnd.toISOString().split('T')[0],end:timelineEnd.toISOString().split('T')[0],progress:0,custom_class:'dummy-task'});
            
            new Gantt("#gantt", tasks, { header_height: 50, bar_height: 25, bar_corner_radius: 10, view_mode: 'Month', custom_popup_html: (task) => { if(task.custom_class === 'dummy-task') return; const original = filteredMilestones.find(m => m.name === task.name); return original ? `<div class="p-2">${createTooltipText(original)}</div>` : ''; } });
        }
        
        const getStatusClasses = (status) => ({ 'Completata': 'bg-green-100 text-green-800 border-green-300', 'In corso': 'bg-yellow-100 text-yellow-800 border-yellow-300', 'Pianificata': 'bg-blue-100 text-blue-800 border-blue-300', 'In ritardo': 'bg-red-100 text-red-800 border-red-300' }[status] || 'bg-gray-100');
        const createTooltipText = (m) => `<strong class="block">${m.name}</strong><span class="block">Progetto: ${m.projectId}</span><span class="block">Inizio: ${m.startDate.toLocaleDateString('it-IT')}</span><span class="block">Fine: ${m.deadline.toLocaleDateString('it-IT')}</span>`;

        dom.projectFilter.addEventListener('change', renderCurrentView);
        dom.viewCardsBtn.addEventListener('click', () => { currentView = 'cards'; dom.viewCardsBtn.classList.add('bg-white','shadow','text-blue-600'); dom.viewGanttBtn.classList.remove('bg-white','shadow','text-blue-600'); renderCurrentView(); });
        dom.viewGanttBtn.addEventListener('click', () => { currentView = 'gantt'; dom.viewGanttBtn.classList.add('bg-white','shadow','text-blue-600'); dom.viewCardsBtn.classList.remove('bg-white','shadow','text-blue-600'); renderCurrentView(); });

        initializeDashboard();
    </script>
</body>
</html>
