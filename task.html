<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Task Operativi - MVP2 Corretto</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .hidden-on-start { display: none; }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text { visibility: hidden; width: 250px; background-color: #1e293b; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .sortable:hover { background-color: #e2e8f0; cursor: pointer; }
        .sort-asc::after { content: ' ▲'; font-size: 0.7em; }
        .sort-desc::after { content: ' ▼'; font-size: 0.7em; }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        
        <header class="mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Dashboard Task Operativi</h1>
            <p class="text-slate-600 mt-1">Analisi dei task (Dati da JSON).</p>
        </header>

        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <div id="filters-panel" class="hidden-on-start grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <select id="project-filter" class="p-2 border rounded-md bg-white shadow-sm w-full"></select>
                <select id="owner-filter" class="p-2 border rounded-md bg-white shadow-sm w-full"></select>
                <select id="status-filter" class="p-2 border rounded-md bg-white shadow-sm w-full">
                    <option value="all">Tutti gli Stati</option>
                    <option value="In corso">In corso</option>
                    <option value="Completato">Completato</option>
                    <option value="Pianificato">Pianificato</option>
                    <option value="Non Iniziata">Non Iniziata</option>
                    <option value="In Ritardo">In Ritardo</option>
                </select>
                <select id="criticality-filter" class="p-2 border rounded-md bg-white shadow-sm w-full">
                    <option value="all">Tutte le Criticità</option>
                    <option value="Alta">Alta</option>
                    <option value="Media">Media</option>
                    <option value="Bassa">Bassa</option>
                </select>
            </div>
        </div>

        <div id="initial-message" class="text-center py-12 bg-white rounded-lg shadow-md">
             <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-slate-400 animate-spin"></i>
            <h3 class="mt-2 text-sm font-medium text-slate-900">Caricamento dati...</h3>
        </div>

        <div id="dashboard-container" class="hidden-on-start">
            <div id="kpi-section" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"></div>
            <div id="preview-section" class="mb-2 text-sm text-slate-500"></div>
            <main id="dashboard-content"></main>
        </div>
    </div>

    <script type="module">
        import { getDataManager } from './utils/datamanager.js';

        let allProcessedTasks = [], filteredTasks = [], sortConfig = { key: 'deadline', direction: 'asc' };
        const dom = {
            initialMessage: document.getElementById('initial-message'),
            dashboardContainer: document.getElementById('dashboard-container'),
            filtersPanel: document.getElementById('filters-panel'),
            projectFilter: document.getElementById('project-filter'),
            ownerFilter: document.getElementById('owner-filter'),
            statusFilter: document.getElementById('status-filter'),
            criticalityFilter: document.getElementById('criticality-filter'),
            kpiSection: document.getElementById('kpi-section'),
            previewSection: document.getElementById('preview-section'),
            dashboardContent: document.getElementById('dashboard-content'),
        };
        
        async function initializeDashboard() {
            try {
                const dm = await getDataManager();
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                allProcessedTasks = dm.task.map(t => {
                    if (!t.ID || !t['Titolo Task'] || !t.Progetto?.[0] || !t.Owner?.[0] || !t['Start Date'] || !t.Deadline) return null;
                    const project = dm.progettiMap.get(t.Progetto[0]);
                    const owner = dm.risorseMap.get(t.Owner[0]);
                    const deadline = new Date(t.Deadline);
                    const isLate = deadline < today && t.Stato !== 'Completato';

                    return {
                        id: t.ID, title: t['Titolo Task'], description: t['Descrizione Task'] || 'N/D',
                        projectName: project ? project['Id Progetto'] : 'N/D',
                        ownerName: owner ? owner['Nome e Cognome'] : 'N/A',
                        startDate: new Date(t['Start Date']), deadline: deadline,
                        status: isLate ? 'In Ritardo' : (t.Stato || 'Pianificato'),
                        criticality: t.Criticità || 'Bassa',
                    };
                }).filter(Boolean);
                
                dom.initialMessage.style.display = 'none';
                dom.dashboardContainer.classList.remove('hidden-on-start');
                dom.filtersPanel.classList.remove('hidden-on-start');

                populateFilters();
                handleUrlParams(dm);
                renderDashboard();
            } catch(error) {
                console.error("Errore:", error);
                dom.initialMessage.innerHTML = `<h3>Errore nel caricamento dei dati.</h3>`;
            }
        }
        
        function handleUrlParams(dm) {
            const urlParams = new URLSearchParams(window.location.search);
            const projectRecordId = urlParams.get('id');
            if (!projectRecordId) return;

            const project = dm.progettiMap.get(projectRecordId);
            if (project) {
                const projectIdReadable = project['Id Progetto'];
                if ([...dom.projectFilter.options].some(o => o.value === projectIdReadable)) {
                    dom.projectFilter.value = projectIdReadable;
                    dom.projectFilter.disabled = true;
                }
            }
        }

        function populateFilters() {
            const projects = ['all', ...new Set(allProcessedTasks.map(t => t.projectName).sort())];
            const owners = ['all', ...new Set(allProcessedTasks.map(t => t.ownerName).sort())];
            dom.projectFilter.innerHTML = projects.map(p => `<option value="${p}">${p === 'all' ? 'Tutti i Progetti' : p}</option>`).join('');
            dom.ownerFilter.innerHTML = owners.map(o => `<option value="${o}">${o === 'all' ? 'Tutti gli Owner' : o}</option>`).join('');
        }

        function renderDashboard() {
            applyFiltersAndSort();
            renderKpis();
            renderTableView();
            lucide.createIcons(); // Assicura che le icone vengano sempre renderizzate
        }
        
        function applyFiltersAndSort() {
            filteredTasks = allProcessedTasks.filter(task => 
                (dom.projectFilter.value === 'all' || task.projectName === dom.projectFilter.value) &&
                (dom.ownerFilter.value === 'all' || task.ownerName === dom.ownerFilter.value) &&
                (dom.statusFilter.value === 'all' || task.status === dom.statusFilter.value) &&
                (dom.criticalityFilter.value === 'all' || task.criticality === dom.criticalityFilter.value)
            );
            filteredTasks.sort((a, b) => {
                let valA = a[sortConfig.key], valB = b[sortConfig.key];
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderKpis() {
            const total = filteredTasks.length;
            const completed = filteredTasks.filter(t => t.status === 'Completato').length;
            const late = filteredTasks.filter(t => t.status === 'In Ritardo').length;
            const critical = filteredTasks.filter(t => t.criticality === 'Alta').length;
            const kpis = [
                { label: 'Task Totali', value: total, icon: 'list-checks' },
                { label: '% Completati', value: `${total > 0 ? Math.round((completed / total) * 100) : 0}%`, icon: 'check-circle-2' },
                { label: 'In Ritardo', value: late, icon: 'siren', color: 'text-red-600' },
                { label: 'Criticità Alta', value: critical, icon: 'flame', color: 'text-orange-600' }
            ];
            dom.kpiSection.innerHTML = kpis.map(kpi => `<div class="bg-white p-4 rounded-lg shadow flex items-center"><div class="p-3 rounded-full bg-blue-100 ${kpi.color || 'text-blue-600'}"><i data-lucide="${kpi.icon}"></i></div><div class="ml-4"><p class="text-sm text-slate-500">${kpi.label}</p><p class="text-xl font-bold text-slate-900">${kpi.value}</p></div></div>`).join('');
        }

        function renderTableView() {
            dom.previewSection.innerHTML = `Mostrando ${filteredTasks.length} su ${allProcessedTasks.length} task.`;
            if (filteredTasks.length === 0) {
                dom.dashboardContent.innerHTML = `<div class="text-center py-10 bg-white rounded-lg shadow"><p>Nessun task corrisponde ai filtri.</p></div>`;
                return;
            }
            const headers = [ { key: 'title', label: 'Task' }, { key: 'projectName', label: 'Progetto' }, { key: 'ownerName', label: 'Owner' }, { key: 'deadline', label: 'Deadline' }, { key: 'status', label: 'Stato' } ];
            dom.dashboardContent.innerHTML = `<div class="overflow-x-auto bg-white rounded-lg shadow"><table class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-50"><tr>${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider sortable" data-sort-key="${h.key}">${h.label}</th>`).join('')}</tr></thead><tbody class="divide-y divide-slate-200">${filteredTasks.map(createTaskRow).join('')}</tbody></table></div>`;
            document.querySelectorAll('.sortable').forEach(header => header.addEventListener('click', () => { const key = header.dataset.sortKey; sortConfig.direction = (sortConfig.key === key && sortConfig.direction === 'asc') ? 'desc' : 'asc'; sortConfig.key = key; renderDashboard(); }));
        }
        
        function createTaskRow(task) {
            const statusInfo = { 'In Ritardo': 'bg-red-100 text-red-800', 'Completato': 'bg-green-100 text-green-800', 'In corso': 'bg-yellow-100 text-yellow-800', 'Pianificato': 'bg-blue-100 text-blue-800', 'Non Iniziata': 'bg-slate-200 text-slate-800' }[task.status] || 'bg-gray-100';
            return `<tr class="hover:bg-slate-50"><td class="px-4 py-4"><div class="tooltip"><span class="font-medium text-slate-900">${task.title}</span><div class="tooltip-text">${task.description}</div></div></td><td class="px-4 py-4 text-sm text-slate-500">${task.projectName}</td><td class="px-4 py-4 text-sm text-slate-500">${task.ownerName}</td><td class="px-4 py-4 text-sm text-slate-500">${dayjs(task.deadline).format('DD/MM/YYYY')}</td><td class="px-4 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusInfo}">${task.status}</span></td></tr>`;
        }

        [dom.projectFilter, dom.ownerFilter, dom.statusFilter, dom.criticalityFilter].forEach(el => el.addEventListener('change', renderDashboard));
        initializeDashboard();
    </script>
</body>
</html>
